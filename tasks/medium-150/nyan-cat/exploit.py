#!/usr/bin/env python3

import re
import sys
import jwt
import requests

from Crypto.PublicKey import RSA
from Crypto.Util.number import inverse


def recover_d(n, e, p):
    q = n // p
    phi = (p - 1) * (q - 1)
    return inverse(e, phi)


def main(url):
    n = 16158503035655503650357438344334975980222051334857742016065172713762327569433945446598600705761456731844358980460949009747059779575245460547544076193224141560315438683650498045875098875194826053398028819192033784138396109321309878080919047169238085235290822926018152521443787945775693134747575978378803821931351155557419988474590062211044096792755643122993194962041009541452039293250034996896313028075525585571446675191481043216788952324950870931945114706225215004684174463331413783953870244692221745977148609857945508601436398472777848659341316410149491512198706015958975558234914441948380669951169048635949237404761
    e = 65537
    p = 0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111011001
    d = recover_d(n, e, p)
    rsa = RSA.construct((n, e, d))
    session = {'broken': False}
    cookie = jwt.encode(session, rsa.exportKey(), algorithm='RS512')
    response = requests.get(url, cookies={'session': cookie.decode()}).text
    flag = re.search(r'flag\{.*?\}', response).group(0)
    print(flag)


if __name__ == '__main__':
    main(sys.argv[1])
