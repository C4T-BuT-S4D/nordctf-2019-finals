#!/usr/bin/env python3

import re
import sys
import jwt
import requests

from Crypto.PublicKey import RSA
from Crypto.Util.number import inverse


def recover_d(n, e, p):
    q = n // p
    phi = (p - 1) * (q - 1)
    return inverse(e, phi)


def main(url):
    n = 16158503035655503650357438344334975980222051334857742016065172713762327569433945446598600705761456731844358980460949009747059779575245460547544076193224141560315438683650498045875098875194826053398028819192033784138396109321309878080919047169238085235290822926018152521443787945791354642779162369073575510464676307738745137368236340488336468229438062757591864495832519542800353637624510899960409953559448637052209587086542698189198304456374481505084668512138820151645511298243115434132458196567714649584872980882921433923431323025741438248940081524739535046106494564661952078162997692569171205852699326923237775905163
    e = 65537
    p = 0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111011001
    d = recover_d(n, e, p)
    rsa = RSA.construct((n, e, d))
    session = {'broken': False}
    cookie = jwt.encode(session, rsa.exportKey(), algorithm='RS512')
    response = requests.get(url, cookies={'session': cookie.decode()}).text
    flag = re.search(r'flag\{.*?\}', response).group(0)
    print(flag)


if __name__ == '__main__':
    main(sys.argv[1])
